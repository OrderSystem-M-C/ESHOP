<title>Objednávky</title>
<div class="orders-page-component">
  <div class="title">
    <div class="title-container-1">
      <h1>Prehľad objednávok</h1>
      <p>{{currentDate}}</p>
    </div>
    <div class="button-container">
      <button type="button" class="btn btn-primary" [routerLink]="['/analytics-page']">
        <img src="../../assets/Images/chart-icon.png" alt="chart-icon"> 
        Štatistiky
      </button>
      <button type="button" class="btn btn-secondary" [routerLink]="['/products-page']">
        <img src="../../assets/Images/products-icon.png" alt="products-icon"> 
        Moje produkty
      </button>
      <button type="button" class="btn btn-success" [routerLink]="['/order-form']">
        <img src="../../assets/Images/create-icon.png" alt="create-icon"> 
        Vytvoriť objednávku
      </button>
      <button type="button" class="btn btn-warning" [routerLink]="['/eph-settings']">
        <img src="./../assets/Images/settings-icon.png" alt="settings-icon"> 
        Nastavenia EPH a poplatkov
      </button>
      <button type="button" class="btn btn-outline-danger" (click)="authService.logout()">
        Odhlásiť sa
      </button>
    </div>
  </div>
  @if(isLoading){
    <div class="spinner-container">
        <div class="spinner">
        </div>
        Načítava sa
    </div>
  }@else{
    @if(selectedOrders.length > 0){
      <div class="title-orders">
        <h2>Upravovací režim</h2>
      </div>
      <div class="service-container">
        <div class="copy-container">
          <button type="button" class="btn btn-light" (click)="copySelectedOrders()"><img src="../../assets/Images/copy-icon.png" alt="copy-icon"> 
            Skopírovať objednávku/y
          </button>
        </div>
        <div class="change-status-container">
          <button type="button" class="btn btn-light" (click)="toggleDropdown('changeStatus')">
            <img src="../../assets/Images/change-status-icon.png"> Rýchla zmena stavu objednávky
          </button>
          <div class="dropdown-content" [ngClass]="dropdownState['changeStatus'] ? 'is-visible': 'is-not-visible'">
            <h3>
              <img src="../../assets/Images/click-icon.png" alt="click-icon"> Kliknutím zmeníte stav:
            </h3>
            <div class="status-item" [ngStyle]="{'border-left': '8px solid ' + status.statusColor}" *ngFor="let status of statuses">
              <a class="status-item-link" (click)="changeOrderStatus(status.statusName)">
                {{status.statusName}}
              </a>
            </div>
          </div>
        </div>
        <div class="select-orders-to-remove-container">
          <button type="button" class="btn btn-light" (click)="removeSelectedOrders()"><img src="../../assets/Images/bin-icon.png" alt="bit-icon"> 
            Odstrániť zvolenú/é objednávku/y
          </button>
        </div>
        <div class="generate-xml-file-from-orders-container">
          <button type="button" class="btn btn-light" (click)="downloadXmlFiles()"><img src="../../assets/Images/xml-icon.png" alt="xml-icon"> 
            Vygenerovať XML
          </button>
        </div>
        <div class="download-invoice-container">
          <button type="button" class="btn btn-light" (click)="downloadInvoices()">
            <img src="../../assets/Images/download-file-icon.png" alt="download-icon" class="download-icon"> Stiahnuť faktúru/y
          </button>
        </div>
        <div class="cancel-selection-container">
          <button type="button" class="btn btn-outline-danger" (click)="clearSelection(true)">
            Zrušiť výber
          </button>
        </div>
      </div>
    }@else{
      <div class="title-orders">
        <h2>Objednávky</h2>
      </div>
      <div class="sorting-container">
        <div class="checkbox-dropdown-container">
          <button type="button" class="btn btn-light dropdown-button" (click)="toggleDropdown('status')"><img src="../../assets/Images/filter-icon.png" alt="filter-icon"> 
            Zvoľte stavy objednávok pre filtráciu
          </button>
          <div class="dropdown-content" [ngClass]="dropdownState['status'] ? 'is-visible': 'is-not-visible'">
            <div class="checkbox-item" 
              [ngStyle]="{'border-left': '8px solid ' + status.statusColor }" 
              [ngClass]="{ 'selected-status': selectedStatuses.includes(status.statusName) }"
              *ngFor="let status of statuses">
              <label class="checkbox-label">
                <input type="checkbox" class="form-check-input" id="checkbox" [value]="status.statusName" (change)="onCheckboxChange($event)" [checked]="selectedStatuses.includes(status.statusName)">
                {{ status.statusName }}
              </label>
            </div>
          </div>
        </div>
        <div class="filter-date-container">
          <button type="button" class="btn btn-light filter-date-dropdown-btn" (click)="toggleDropdown('date')"><img src="../../assets/Images/date-icon.png" alt="date-icon"> 
            Zvoľte filtráciu podľa dátumu
          </button>
          <div class="dropdown-content" [ngClass]="dropdownState['date'] ? 'is-visible': 'is-not-visible'">
            <div class="filter-date-field">
              <div class="filter-date-item" (click)="setSort('date', 'newest')">
                <span>Najnovšie</span>
              </div>
              <div class="filter-date-item" (click)="setSort('date', 'oldest')">
                <span>Najstaršie</span>
              </div>
            </div>
          </div>
        </div>
        <div class="filter-price-container">
          <button type="button" class="btn btn-light filter-price-dropdown-btn" (click)="toggleDropdown('price')">
            <img src="../../assets/Images/price-icon.png" alt="price-icon"> Zvoľte filtráciu podľa ceny
          </button>
          <div class="dropdown-content" [ngClass]="dropdownState['price'] ? 'is-visible': 'is-not-visible'">
            <div class="filter-price-field">
              <div class="filter-price-item" (click)="setSort('price', 'asc')">
                <span>Od najlacnejšieho</span>
              </div>
              <div class="filter-price-item" (click)="setSort('price', 'desc')">
                <span>Od najdrahšieho</span>
              </div>
            </div>
          </div>
        </div>
        <div class="filter-name-container">
          <button type="button" class="btn btn-light filter-name-dropdown-btn" (click)="toggleDropdown('name')">
            <img src="../../assets/Images/name-filter-icon.png" alt="name-filter-icon"> Zvoľte filtráciu podľa mena
          </button>
          <div class="dropdown-content" [ngClass]="dropdownState['name'] ? 'is-visible': 'is-not-visible'">
            <div class="filter-name-field">
              <div class="filter-name-item" (click)="setSort('name', 'asc')">
                <span>Meno: A → Z</span>
              </div>
              <div class="filter-name-item" (click)="setSort('name', 'desc')">
                <span>Názov: Z → A</span>
              </div>
            </div>
          </div>
        </div>
        <div class="select-all-orders-container">
          <button type="button" class="btn btn-outline-primary" (click)="selectAllOrders()" *ngIf="ordersData.length > 0"> 
            Zvoliť všetky
          </button>
        </div>
      </div>
    }
    <div class="search-bar">
      <input type="search" class="form-control" placeholder="Kliknite sem pre vyhľadávanie objednávok" [(ngModel)]="searchText" (input)="searchOrders()">
      <select class="form-control" [(ngModel)]="searchOption" (change)="searchOrders()">
        <option selected value="auto">Automatické vyhľadávanie</option>
        <option value="customerName">Vyhľadávanie podľa mena a priezviska</option>
        <option value="orderId">Vyhľadávanie podľa čísla objednávky</option>
        <option value="email">Vyhľadávanie podľa e-mailovej adresy</option>
        <option value="product">Vyhľadávanie podľa produktov objednávky</option>
        <option value="note">Vyhľadávanie podľa poznámky</option>
      </select>
    </div>
      @if(filteredOrders.length > 0){
      <table class="orders-table">
        <thead>
          <tr>
            <th class="text-center">Náhľad</th>
            <th>Dátum</th>
            <th class="text-center">Číslo objednávky</th>
            <th>Meno</th>
            <th class="text-center">Celková cena</th>
            <th class="text-center">Platba</th>
            <th>Stav objednávky</th>
            <th class="text-center">Podacie číslo</th>
            <th style="width: 100px !important; text-align: center;">Zvoliť</th>
          </tr>
        </thead>
        <tbody>
          <tr
            *ngFor="let order of ourFilteredOrders"
            class="order-row"
            [class.selected]="selectedOrders.includes(order)"
            [ngClass]="{
              'danger-status': order.orderStatus === 'Objednávka stornovaná' || 
                                order.orderStatus === 'Oprava objednávky' || 
                                order.orderStatus === 'Rozbité, zničené, vrátené' || 
                                order.orderStatus === 'Neznáma príčina' }"
            (click)="navigateToDetails(order, $event)">
            <td>
              <div class="preview-container"
                  (mouseenter)="hoveredOrder = order"
                  (mouseleave)="hoveredOrder = null"
                  style="position: relative;">
                <img src="../../assets/Images/preview-icon.png" class="preview-icon" style="cursor: pointer;">
                
                <ng-container *ngIf="hoveredOrder === order">
                  <div class="preview-popup" [routerLink]="['/order-details', order.orderId]">
                    <app-order-details [order]="order" [previewOrderId]="order.orderId"></app-order-details>
                  </div>
                </ng-container>
              </div>
            </td>
            <td>{{ order.orderDate }}</td>
            <td class="text-center">{{ order.orderId }}</td>
            <td>
              <div class="scrollable-cell">{{ order.customerName }}</div>
            </td>
            <td class="text-center">{{ order.totalPrice }}€</td>
            <td class="text-center">{{ order.paymentOption }}</td>
            <td>
              <div class="scrollable-cell">
                {{ order.orderStatus }}
              </div>
            </td>
            <td class="text-center">{{ order.packageCode ? order.packageCode : 'Nezadané' }}</td>
            <td
              class="checkbox-section"
              [attr.title]="order.orderStatus"
              [ngStyle]="{'border-right': '8px solid ' + getStatusColor(order.orderStatus)}">
              <div style="display: flex; justify-content: center; align-items: center;">
                <input
                  type="checkbox"
                  class="form-check-input"
                  [(ngModel)]="order.orderSelected"
                  (change)="selectOrder()"
                  data-skip-navigation
                />
              </div>
            </td>
          </tr>
        </tbody>
      </table>
      <div class="pagination-container">
        <mat-paginator [length]="totalItems" [pageSizeOptions]="[6, 8, 10]" [pageSize]="pageSize" [pageIndex]="pageIndex" (page)="handlePageEvent($event)" aria-label="Zvolte si stránku" showFirstLastButtons></mat-paginator>
      </div>
    }@else if(filteredOrders.length === 0 && ordersData.length > 0){
      <div class="no-orders-container">
        <h3>Neboli nájdené žiadne objednávky.</h3>
      </div>
    }
    @else{
      <div class="no-orders-container">
        <h3>Nemáte žiadne objednávky, kliknutím <span class="order-link" [routerLink]="['/order-form']">sem</span> si vytvorte objednávku.</h3>
      </div>
    }
  }
</div>
<div id="hidden-invoice-container" style="display:none;"></div>

